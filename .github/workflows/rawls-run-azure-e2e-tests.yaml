name: rawls-run-azure-e2e-tests

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch of rawls to run tests on'
        required: true
        default: 'develop'
        type: string

jobs:
  rawls-build-tag-publish-job:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
    outputs:
      custom-version-json: ${{ steps.rawls-build-tag-publish.outputs.rawls-custom-version-json }}
    steps:
      - uses: actions/checkout@v2
      - name: Build and publish rawls
        id: 'rawls-build-tag-publish'
        uses: ./.github/actions/rawls-build-tag-publish
        with:
          rawls-branch: ${{ inputs.branch }}
          token: ${{ secrets.BROADBOT_TOKEN }}

  create-bee-workflow:
    runs-on: ubuntu-latest
    needs: [rawls-build-tag-publish-job]
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - uses: actions/checkout@v2
      - name: create bee
        uses: ./.github/actions/create-bee
        with:
          rawls-custom-version-json: ${{ needs.rawls-build-tag-publish-job.outputs.custom-version-json }}
          terra-env: 'dev'
          token: ${{ secrets.BROADBOT_TOKEN }}

  rawls-swat-e2e-test-job:
    runs-on: ubuntu-latest
    needs: [create-bee-workflow]
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - uses: actions/checkout@v2
      - name: dispatch swat workflow
        uses: ./.github/actions/run-swat-workflow
        with:
          ref: ${{ inputs.branch }}
          terra-env: dev
          testing-env: qa
          group-name: workspaces_azure
          group-tag: '-n org.broadinstitute.dsde.test.api.WorkspacesAzureTest'
          token: ${{ secrets.BROADBOT_TOKEN }}

  destroy-bee-workflow:
    runs-on: ubuntu-latest
    needs: [rawls-swat-e2e-test-job]
    if: always() # always run to confirm bee is destroyed
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - uses: actions/checkout@v2
      - name: destroy bee
        uses: ./.github/actions/destroy-bee
        with:
          terra-env: 'dev'
          token: ${{ secrets.BROADBOT_TOKEN }}

  notify-slack-on-failure:
    runs-on: ubuntu-latest
    needs: [rawls-build-tag-publish-job, create-bee-workflow, rawls-swat-e2e-test-job, destroy-bee-workflow] # Want to notify regardless of which step fails
    if: false # ${{ failure() }} # Can use !cancelled() if always want to notify.
    steps:
      - name: Notify slack
        uses: slackapi/slack-github-action@v1.23.0
        with:
          # Channel is for #dsp-workspaces-test-alerts
          channel-id: 'C03F21QEWV7'
          slack-message: "Azure E2E Tests FAILED, branch: ${{ inputs.branch }}\n${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACKBOT_TOKEN }}
