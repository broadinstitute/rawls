name: rawls-build-tag-publish-and-run-tests

on:
  pull_request:
    paths-ignore: ['**.md']
  push:
    branches:
      - develop
    paths-ignore: ['**.md']

jobs:
  rawls-build-tag-publish-job:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
    outputs:
      custom-version-json: ${{ steps.rawls-build-tag-publish.outputs.rawls-custom-version-json }}
    steps:
      - uses: actions/checkout@v2
      - name: Build and publish rawls
        id: 'rawls-build-tag-publish'
        uses: ./.github/actions/rawls-build-tag-publish
        with:
          token: ${{ secrets.BROADBOT_TOKEN }}

  create-bee-workflow:
    runs-on: ubuntu-latest
    needs: [rawls-build-tag-publish-job]
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - uses: actions/checkout@v2
      - name: create bee
        uses: ./.github/actions/create-bee
        with:
          rawls-custom-version-json: ${{ needs.rawls-build-tag-publish-job.outputs.custom-version-json }}
          terra-env: 'dev'
          token: ${{ secrets.BROADBOT_TOKEN }}

  rawls-swat-test-job:
    strategy:
      matrix:
        terra-env: [ dev ] # what versions of apps do we use to emulate types of environments
        testing-env: [ qa ] # what env resources to use, e.g. SA keys
        test-group: [
          { group_name: workspaces, tag: "-n org.broadinstitute.dsde.test.api.AuthDomainsTest -n org.broadinstitute.dsde.test.api.BillingsTest -n org.broadinstitute.dsde.test.api.WorkspacesTest" },
          { group_name: analysis_journeys, tag: "-n org.broadinstitute.dsde.test.api.DataRepoSnapshotsTest" },
          { group_name: workflows, tag: "-n org.broadinstitute.dsde.test.api.MethodsTest" }
        ] # Rawls test groups
    runs-on: ubuntu-latest
    needs: [create-bee-workflow]
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - uses: actions/checkout@v2
      - name: dispatch swat workflow
        uses: ./.github/actions/run-swat-workflow
        with:
          ref: ${{ jobs.rawls-build-tag-publish-job.outputs.rawls-ref }}
          terra-env: ${{ matrix.terra-env }}
          testing-dev: ${{ matrix.testing-env }}
          group-name: ${{ matrix.test-group.group_name }}
          group-tag: ${{ matrix.test-group.tag }}
          token: ${{ secrets.BROADBOT_TOKEN }}

  destroy-bee-workflow:
    runs-on: ubuntu-latest
    needs: [rawls-swat-test-job]
    if: always() # always run to confirm bee is destroyed
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - uses: actions/checkout@v2
      - name: destroy bee
        uses: ./.github/actions/destroy-bee
        with:
          terra-env: 'dev'
          token: ${{ secrets.BROADBOT_TOKEN }}
