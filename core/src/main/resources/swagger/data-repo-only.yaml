# if Rawls config specifies dataRepo.enabled = true, this file is merged into api-docs.yaml.
# merge mechanics are implemented by Circe's Json.deepMerge (tl;dr: objects are merged by key,
# values are overwritten)
#
# so, this file should only contain the swagger additions to support data repo integration.

paths:
  '/api/workspaces/{workspaceNamespace}/{workspaceName}/entities':
    get:
      parameters:
        - $ref: '#/parameters/workspaceNamespacePathParam'
        - $ref: '#/parameters/workspaceNamePathParam'
        - $ref: '#/parameters/dataReferenceQueryParam'
        - $ref: '#/parameters/billingProjectQueryParam'

  '/api/workspaces/{workspaceNamespace}/{workspaceName}/entities/delete':
    post:
      parameters:
        - $ref: '#/parameters/workspaceNamespacePathParam'
        - $ref: '#/parameters/workspaceNamePathParam'
        - in: body
          description: Set of entities to delete
          name: entities
          required: true
          schema:
            type: array
            items:
              $ref: '#/definitions/AttributeEntityReference'
        - $ref: '#/parameters/dataReferenceQueryParam'
        - $ref: '#/parameters/billingProjectQueryParam'
  '/api/workspaces/{workspaceNamespace}/{workspaceName}/snapshots':
    post:
      responses:
        '201':
          description: Created
          schema:
            $ref: '#/definitions/DataRepoSnapshotReference'
        '404':
          description: Workspace or snapshot not found
          schema:
            $ref: '#/definitions/ErrorReport'
        '500':
          description: Rawls Internal Error
          schema:
            $ref: '#/definitions/ErrorReport'
      description: "Add a reference to a snapshot in the Terra Data Repo"
      tags:
        - snapshots
      summary: Create a snapshot
      operationId: createDataRepoSnapshot
      parameters:
        - $ref: '#/parameters/workspaceNamespacePathParam'
        - $ref: '#/parameters/workspaceNamePathParam'
        - in: body
          description: Reference to the Data Repo snapshot
          name: dataRepoSnapshot
          required: true
          schema:
            $ref: '#/definitions/DataRepoSnapshot'
    get:
      responses:
        '200':
          description: OK
          schema:
            $ref: '#/definitions/DataRepoSnapshotList'
        '404':
          description: Workspace not found or user lacks permissions
          schema:
            $ref: '#/definitions/ErrorReport'
        '500':
          description: Rawls Internal Error
          schema:
            $ref: '#/definitions/ErrorReport'
      description: "Enumerate references to snapshots in the Terra Data Repo"
      tags:
        - snapshots
      summary: List snapshots
      operationId: enumerateDataRepoSnapshot
      parameters:
        - $ref: '#/parameters/workspaceNamespacePathParam'
        - $ref: '#/parameters/workspaceNamePathParam'
        - in: query
          name: offset
          description: The number of items to skip before starting to collect the result set.
          type: int
          required: true
        - in: query
          name: limit
          description: The number of items to return.
          type: int
          required: true
    security:
      - authorization:
          - openid
          - email
          - profile

  '/api/workspaces/{workspaceNamespace}/{workspaceName}/snapshots/{snapshotId}':
    get:
      responses:
        '200':
          description: OK
          schema:
            $ref: '#/definitions/DataRepoSnapshotReference'
        '404':
          description: Workspace or snapshot not found
          schema:
            $ref: '#/definitions/ErrorReport'
        '500':
          description: Rawls Internal Error
          schema:
            $ref: '#/definitions/ErrorReport'
      description: "Get a reference to a snapshot in the Terra Data Repo"
      tags:
        - snapshots
      summary: Get a snapshot
      operationId: getDataRepoSnapshot
      parameters:
        - $ref: '#/parameters/workspaceNamespacePathParam'
        - $ref: '#/parameters/workspaceNamePathParam'
        - $ref: '#/parameters/snapshotIdPathParam'
    delete:
      responses:
        '204':
          description: Successful Request
        '404':
          description: Workspace or snapshot not found
          schema:
            $ref: '#/definitions/ErrorReport'
        '500':
          description: Rawls Internal Error
          schema:
            $ref: '#/definitions/ErrorReport'
      description: "Delete a workspace's reference to a snapshot in the Terra Data Repo"
      tags:
        - snapshots
      summary: Delete a snapshot
      operationId: deleteDataRepoSnapshot
      parameters:
        - $ref: '#/parameters/workspaceNamespacePathParam'
        - $ref: '#/parameters/workspaceNamePathParam'
        - $ref: '#/parameters/snapshotIdPathParam'
      security:
        - authorization:
            - openid
            - email
            - profile

parameters:
  billingProjectQueryParam:
    in: query
    description: Billing project to use for queries to the data reference
    name: billingProject
    required: false
    type: string
  dataReferenceQueryParam:
    in: query
    description: Data reference name to query for entity metadata
    name: dataReference
    required: false
    type: string
  snapshotIdPathParam:
    in: path
    description: The snapshot ID
    name: snapshotId
    required: true
    type: string
  workspaceNamespacePathParam:
    in: path
    description: The workspace namespace
    name: workspaceNamespace
    required: true
    type: string
  workspaceNamePathParam:
    in: path
    description: The workspace name
    name: workspaceName
    required: true
    type: string

definitions:
  DataRepoSnapshot:
    description: A Data Repo snapshot
    properties:
      snapshotId:
        type: string
        description: The ID of the snapshot in Terra Data Repo
      name:
        type: string
        description: The name of the snapshot

  DataRepoSnapshotReference:
    description: A Data Reference definition from Workspace Manager
    properties:
      referenceId:
        type: string
      name:
        type: string
      workspaceId:
        type: string
      referenceType:
        type: string
      reference:
        type: object
      cloningInstructions:
        type: string

  DataRepoSnapshotReferenceList:
    description: A list of DataRepoSnapshotReferences
    properties:
      resources:
        description: A list of Data Reference definitions from Workspace Manager
        type: array
        items:
          $ref: '#/definitions/DataRepoSnapshotReferences'
