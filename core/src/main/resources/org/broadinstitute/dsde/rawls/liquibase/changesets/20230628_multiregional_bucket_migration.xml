<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog logicalFilePath="dummy" xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">
    <changeSet logicalFilePath="dummy" author="mtalbott" id="create_MULTIREGIONAL_BUCKET_MIGRATION_HISTORY">
        <createTable tableName="MULTIREGIONAL_BUCKET_MIGRATION_HISTORY"
                     remarks="Records the history and progress of multiregional -> single region workspace bucket migration attempts">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="WORKSPACE_ID"
                    type="BINARY(16)"
                    remarks="ID of the WORKSPACE being migrated.">
                <constraints nullable="false"/>
            </column>
            <column name="CREATED"
                    type="DATETIME"
                    defaultValueComputed="CURRENT_TIMESTAMP"
                    remarks="When the system scheduled migrating the WORKSPACE.">
                <constraints nullable="false"/>
            </column>
            <column name="STARTED"
                    type="DATETIME"
                    remarks="When the system started migrating the WORKSPACE.">
                <constraints nullable="true"/>
            </column>
            <column name="FINISHED"
                    type="DATETIME"
                    remarks="When the system finished migrating the WORKSPACE.">
                <constraints nullable="true"/>
            </column>
            <column name="UPDATED"
                    type="DATETIME"
                    defaultValueComputed="CURRENT_TIMESTAMP"
                    remarks="When the system last performed a step in the migration on the WORKSPACE.">
                <constraints nullable="false"/>
            </column>
            <column name="OUTCOME"
                    type="VARCHAR(16)"
                    remarks="The state of migrating the WORKSPACE when the system FINISHED.">
                <constraints nullable="true"/>
            </column>
            <column name="MESSAGE"
                    type="TEXT"
                    remarks="Any supplemental message generated by the system, including failure messages.">
                <constraints nullable="true"/>
            </column>
            <column name="WORKSPACE_BUCKET_IAM_REMOVED"
                    type="DATETIME"
                    remarks="When the system removed IAM from the original workspace bucket.">
                <constraints nullable="true"/>
            </column>
            <column name="TMP_BUCKET_NAME"
                    type="VARCHAR(254)"
                    remarks="The name of the temporary bucket.">
                <constraints nullable="true"/>
            </column>
            <column name="TMP_BUCKET_CREATED"
                    type="DATETIME"
                    remarks="When the system created the temporary bucket.">
                <constraints nullable="true"/>
            </column>
            <column name="WORKSPACE_BUCKET_TRANSFER_IAM_CONFIGURED"
                    type="DATETIME"
                    remarks="When the system configured IAM for the workspace bucket transfer.">
                <constraints nullable="true"/>
            </column>
            <column name="WORKSPACE_BUCKET_TRANSFER_JOB_ISSUED"
                    type="DATETIME"
                    remarks="When the system issued the transfer from workspace bucket to temporary bucket.">
                <constraints nullable="true"/>
            </column>
            <column name="WORKSPACE_BUCKET_TRANSFERRED"
                    type="DATETIME"
                    remarks="When the transfer job from workspace bucket to temporary bucket completed.">
                <constraints nullable="true"/>
            </column>
            <column name="WORKSPACE_BUCKET_DELETED"
                    type="DATETIME"
                    remarks="When the system deleted the original workspace bucket.">
                <constraints nullable="true"/>
            </column>
            <column name="FINAL_BUCKET_CREATED"
                    type="DATETIME"
                    remarks="When the system created the final workspace bucket.">
                <constraints nullable="true"/>
            </column>
            <column name="TMP_BUCKET_TRANSFER_IAM_CONFIGURED"
                    type="DATETIME"
                    remarks="When the system configured IAM for the temporary bucket transfer.">
                <constraints nullable="true"/>
            </column>
            <column name="TMP_BUCKET_TRANSFER_JOB_ISSUED"
                    type="DATETIME"
                    remarks="When the system issued the transfer from temporary bucket to new workspace bucket.">
                <constraints nullable="true"/>
            </column>
            <column name="TMP_BUCKET_TRANSFERRED"
                    type="DATETIME"
                    remarks="When the transfer job from temporary bucket to new workspace bucket completed.">
                <constraints nullable="true"/>
            </column>
            <column name="TMP_BUCKET_DELETED"
                    type="DATETIME"
                    remarks="When the system deleted the temporary bucket.">
                <constraints nullable="true"/>
            </column>
            <column name="REQUESTER_PAYS_ENABLED"
                    type="BOOLEAN"
                    remarks="Whether the workspace bucket was requester pays."
                    defaultValueBoolean="false">
            </column>
        </createTable>
    </changeSet>
    <changeSet logicalFilePath="dummy" author="mtalbott" id="create_MULTIREGIONAL_BUCKET_MIGRATION_HISTORY_FK">
        <addForeignKeyConstraint baseColumnNames="WORKSPACE_ID"
                                 baseTableName="MULTIREGIONAL_BUCKET_MIGRATION_HISTORY"
                                 constraintName="FK_MULTIREGIONAL_BUCKET_MIGRATION_HISTORY_WORKSPACE"
                                 deferrable="false"
                                 initiallyDeferred="false"
                                 onDelete="CASCADE"
                                 onUpdate="NO ACTION"
                                 referencedColumnNames="id"
                                 referencedTableName="WORKSPACE"/>
    </changeSet>
    <changeSet logicalFilePath="dummy" author="mtalbott"
               id="create_MULTIREGIONAL_BUCKET_MIGRATION_HISTORY_insertion_trigger">
        <comment>
            The task of migrating a multiregional bucket to a single region might fail for a number
            of reasons, and it's important that we record these failures. An attempt at migrating
            any particular workspace bucket is represented by an insertion into
            MULTIREGIONAL_BUCKET_MIGRATION_HISTORY. To prevent concurrent attempts, we'll only allow
            insertions when previous attempts have FINISHED.
        </comment>
        <sql endDelimiter="~">
            CREATE TRIGGER fail_insert_if_workspace_bucket_is_being_migrated
                BEFORE INSERT ON MULTIREGIONAL_BUCKET_MIGRATION_HISTORY
                FOR EACH ROW
            BEGIN
                IF (SELECT COUNT(*) FROM MULTIREGIONAL_BUCKET_MIGRATION_HISTORY h
                    WHERE h.WORKSPACE_ID = NEW.WORKSPACE_ID AND h.FINISHED IS NULL)
                THEN
                    SET @error_message = CONCAT_WS(' ', 'Workspace', NEW.WORKSPACE_ID, 'is already being migrated.');
                SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @error_message;
            END IF;
            END ~
        </sql>
        <rollback>
            DROP TRIGGER IF EXISTS fail_insert_if_workspace_bucket_is_being_migrated;
        </rollback>
    </changeSet>
    <changeSet logicalFilePath="dummy" author="mtalbott" id="create_MULTIREGIONAL_BUCKET_MIGRATION_STORAGE_TRANSFER_SERVICE_JOB">
        <createTable tableName="MULTIREGIONAL_BUCKET_MIGRATION_STORAGE_TRANSFER_SERVICE_JOB"
                     remarks="Records the job information for STS jobs used in multiregional bucket migration.">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="JOB_NAME"
                    type="varchar(254)"
                    remarks="Name of STS job.">
                <constraints nullable="false"/>
            </column>
            <column name="MIGRATION_ID"
                    type="BIGINT"
                    remarks="Migration ID this STS job is associated with.">
                <constraints nullable="false"/>
            </column>
            <column name="CREATED"
                    type="DATETIME"
                    defaultValueComputed="CURRENT_TIMESTAMP"
                    remarks="When the system submitted this job to STS.">
                <constraints nullable="false"/>
            </column>
            <column name="UPDATED"
                    type="DATETIME"
                    defaultValueComputed="CURRENT_TIMESTAMP"
                    remarks="When the system last checked the status of this job.">
                <constraints nullable="false"/>
            </column>
            <column name="FINISHED"
                    type="DATETIME"
                    remarks="When this job finished.">
                <constraints nullable="true"/>
            </column>
            <column name="OUTCOME"
                    type="VARCHAR(16)"
                    remarks="Outcome of the STS job.">
                <constraints nullable="true"/>
            </column>
            <column name="MESSAGE"
                    type="TEXT"
                    remarks="Any supplemental message generated by the system, including failure messages.">
                <constraints nullable="true"/>
            </column>
            <column name="SOURCE_BUCKET"
                    type="VARCHAR(254)"
                    remarks="Name of source bucket this STS job is transferring data from.">
                <constraints nullable="false"/>
            </column>
            <column name="DESTINATION_BUCKET"
                    type="VARCHAR(254)"
                    remarks="Name of destination bucket this STS job is transferring data to.">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet logicalFilePath="dummy" author="mtalbott" id="create_MULTIREGIONAL_BUCKET_MIGRATION_STORAGE_TRANSFER_SERVICE_JOB_FK">
        <addForeignKeyConstraint baseColumnNames="MIGRATION_ID"
                                 baseTableName="MULTIREGIONAL_BUCKET_MIGRATION_STORAGE_TRANSFER_SERVICE_JOB"
                                 constraintName="FK_MULTIREGIONAL_BUCKET_MIGRATION_STORAGE_TRANSFER_SERVICE_JOB"
                                 deferrable="false"
                                 initiallyDeferred="false"
                                 onDelete="CASCADE"
                                 onUpdate="NO ACTION"
                                 referencedColumnNames="id"
                                 referencedTableName="MULTIREGIONAL_BUCKET_MIGRATION_HISTORY"/>
    </changeSet>
    <changeSet logicalFilePath="dummy" author="mtalbott" id="create_MULTIREGIONAL_BUCKET_MIGRATION_RETRIES">
        <createTable tableName="MULTIREGIONAL_BUCKET_MIGRATION_RETRIES"
                     remarks="Records the number of retries for a multiregional bucket migration attempt">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="MIGRATION_ID"
                    type="BIGINT"
                    remarks="Migration ID this retry count is associated with.">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="RETRIES"
                    type="BIGINT"
                    defaultValue="0"
                    remarks="Number of times this workspace migration has been retried">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet logicalFilePath="dummy" author="mtalbott" id="create_MULTIREGIONAL_BUCKET_MIGRATION_RETRIES_FK">
        <addForeignKeyConstraint baseColumnNames="MIGRATION_ID"
                                 baseTableName="MULTIREGIONAL_BUCKET_MIGRATION_RETRIES"
                                 constraintName="FK_MULTIREGIONAL_BUCKET_MIGRATION_RETRIES"
                                 deferrable="false"
                                 initiallyDeferred="false"
                                 onDelete="CASCADE"
                                 onUpdate="NO ACTION"
                                 referencedColumnNames="id"
                                 referencedTableName="MULTIREGIONAL_BUCKET_MIGRATION_HISTORY"/>
    </changeSet>
</databaseChangeLog>
