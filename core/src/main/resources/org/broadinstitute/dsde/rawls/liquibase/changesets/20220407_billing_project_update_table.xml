<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog logicalFilePath="dummy" xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">
    <changeSet logicalFilePath="dummy" author="ci-mob" id="create_BILLING_PROJECT_UPDATES">
        <createTable tableName="BILLING_PROJECT_UPDATES"
                     remarks="Records the history of billing account changes on billing projects">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="BILLING_PROJECT_NAME"
                    type="VARCHAR(254)"
                    remarks="Name of the billing project being updated.">
                <constraints nullable="false"/>
            </column>
            <column name="USER_ID"
                    type="VARCHAR(254)"
                    remarks="User ID of the user making the change.">
                <constraints nullable="false"/>
            </column>
            <column name="ORIGINAL_BILLING_ACCOUNT"
                    type="VARCHAR(100)"
                    remarks="The billing account used by billing project previously.">
                <constraints nullable="true"/>
            </column>
            <column name="NEW_BILLING_ACCOUNT"
                    type="VARCHAR(100)"
                    remarks="The new billing account that the user requested for the billing project.">
                <constraints nullable="true"/>
            </column>
            <column name="CREATED"
                    type="DATETIME(6)"
                    defaultValueComputed="NOW(6)"
                    remarks="When this change was requested.">
                <constraints nullable="false"/>
            </column>
            <column name="FINISHED"
                    type="DATETIME"
                    remarks="When the system finished migrating the WORKSPACE.">
                <constraints nullable="true"/>
            </column>
            <column name="OUTCOME"
                    type="VARCHAR(16)"
                    remarks="The state of migrating the WORKSPACE when the system FINISHED.">
                <constraints nullable="true"/>
            </column>
            <column name="MESSAGE"
                    type="TEXT"
                    remarks="Any supplemental message generated by the system, including failure messages.">
                <constraints nullable="true"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet logicalFilePath="dummy" author="ci-mob" id="create_BILLING_PROJECT_UPDATES_FK">
        <addForeignKeyConstraint baseColumnNames="BILLING_PROJECT_NAME"
                                 baseTableName="BILLING_PROJECT_UPDATES"
                                 constraintName="FK_BILLING_PROJECT_NAME"
                                 deferrable="false"
                                 initiallyDeferred="false"
                                 onUpdate="NO ACTION"
                                 referencedColumnNames="NAME"
                                 referencedTableName="BILLING_PROJECT"/>
    </changeSet>
    <changeSet logicalFilePath="dummy" author="ci-mob"
               id="create_BILLING_PROJECT_UPDATES_insertion_trigger">
        <comment>
            Enforce that the billing account can't be changed from/to the same billing account.
        </comment>
        <sql endDelimiter="~">
            CREATE TRIGGER fail_insert_if_billing_account_same
                BEFORE INSERT ON BILLING_PROJECT_UPDATES
                FOR EACH ROW
            BEGIN
                IF (NEW.ORIGINAL_BILLING_ACCOUNT <=> NEW.NEW_BILLING_ACCOUNT)
                THEN
                    SET @error_message = CONCAT_WS(' ', 'Billing account', NEW.NEW_BILLING_ACCOUNT, 'is the same as the original billing account.');
                SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @error_message;
            END IF;
            END ~
        </sql>
        <rollback>
            DROP TRIGGER IF EXISTS fail_insert_if_workspace_is_being_migrated;
        </rollback>
    </changeSet>
</databaseChangeLog>
