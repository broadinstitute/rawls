{{with $environment := env "ENVIRONMENT"}}
{{$keyname := printf "secret/dsde/%s/rawls/rawls-compose.yaml" $environment}}
{{with vault $keyname}}

proxy:
  image: broadinstitute/openidc-proxy:latest
  {{.Data.proxy_ports}}
  {{.Data.proxy_volumes}}
  environment:
    AUTH_TYPE: AuthType None
    AUTH_TYPE2: AuthType oauth20
    CLIENTID: {{.Data.env_client_id}}
    CLIENTSECRET: {{.Data.env_client_secret}}
    CALLBACK_URI: {{.Data.env_callback_uri}}
    LOG_LEVEL: debug
    OIDC_CLAIM: Require all granted
    OIDC_CLAIM2: Require valid-user
    PROXY_PATH: /
    PROXY_PATH2: /api
    PROXY_PATH3: /register
    SERVER_NAME: {{.Data.env_server_name}}
    AUTH_REQUIRE2: Require ldap-group {{.Data.proxy_ldap_group}}
    AUTH_LDAP_URL2: 'AuthLDAPURL "{{.Data.proxy_ldap_url}}"'
    AUTH_LDAP_GROUP_ATTR2: 'AuthLDAPGroupAttribute member'
    REMOTE_USER_CLAIM: sub

{{end}}
{{end}}
